@page "/weather"
@using VideoManager.Models
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject ProtectedSessionStorage ProtectedSessionStore
@inject IRealmService RealmService
@inject HttpClient Http
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@inject IHttpClientFactory ClientFactory
@rendermode InteractiveServer

<PageTitle>Weather</PageTitle>

<h1>Weather</h1>

<section>

    <div style="display: flex;">
        <div style="flex: 1; background: lightblue; padding: 10px;">
            <p> Block 1: Realm Editor </p>

            <EditForm EditContext="@editContext">

                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="mb-3">
                    <label class="form-label">Realm Name:</label>
                    <InputText @bind-Value="currentRealm.name" Placeholder="Enter name" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Realm View:</label>
                    <InputText @bind-Value="currentRealm.view" Placeholder="Enter view" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Realm Action:</label>
                    <InputSelect @bind-Value="currentRealm.DefaultAction">
                        @foreach (ExplorerDefaultAction action in Enum.GetValues(typeof(ExplorerDefaultAction)))
                        {
                            <option value="@action">@action</option>
                        }
                    </InputSelect>
                </div>

                @if (currentRealm.DefaultAction == ExplorerDefaultAction.OpenLink)
                {

                    <div class="mb-3">
                        <label class="form-label">Realm App:</label>
                        <InputText @bind-Value="currentRealm.PreferredApp"
                                   placeholder="com.myapp.handler" />
                    </div>

                }

                <Button Color="ButtonColor.Primary"
                        Disabled="@(!formIsValid)"
                        @ref=addButton
                        @onclick="HandleButtonAddTagClick">
                    Add / Update
                </Button>

                <Button Color="ButtonColor.Danger"
                        Disabled="@(!formIsValid)"
                        @ref=deleteButton
                        @onclick="HandleButtonDeleteTagClick">
                    Delete
                </Button>

            </EditForm>
        </div>
        <div style="flex: 1; background: lightgreen; padding: 10px;">
            <p> Block 1a: Realm Management </p>

            <InputFile OnChange="HandleInputConsumeClick" />
            <Button @ref="deleteButton" Color="ButtonColor.Danger" @onclick="HandleButtonDeleteTagClick"> Delete </Button>

        </div>
    </div>

</section>

<section>

    <p> Block 2: Realm Choice </p>

    @if (allRealms == null)
    {
        <p role="status">No realms found...</p>
    }
    else
    {

        <Grid TItem="Realm"
              AllowRowClick="true"
              AllowSorting="true"
              Class="table table-hover"
              Data="allRealms"
              HeaderRowCssClass="bg-primary text-white border-bottom-0"
              OnRowClick="OnRowClick"
              Responsive="true">

            <GridColumns>
                <GridColumn TItem="Realm" HeaderText="Name">
                    @context.name
                </GridColumn>

                <GridColumn TItem="Realm" HeaderText="View">
                    @context.view
                </GridColumn>
            </GridColumns>

        </Grid>
    }

</section>

@code {

    private Realm currentRealm = new Realm();
    private List<Realm> allRealms = default!;

    private EditContext editContext = default!;

    private Button addButton = default!;
    private Button deleteButton = default!;

    private Button consumeButton = default!;
    private Button pumpButton = default!;
    private Button dumpButton = default!;

    private bool formIsValid = false;

    private bool isConnected;

    protected override void OnInitialized()
    {
        editContext = new EditContext(currentRealm);
        editContext.OnValidationStateChanged += HandleValidationChanged;
        base.OnInitialized();
    }

    protected override async Task OnInitializedAsync()
    {
        currentRealm.name = "";
        allRealms = await RealmService.GetRealmList();
        await base.OnInitializedAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            isConnected = true;
            StateHasChanged();
        }
    }

    private async Task OnRowClick(GridRowEventArgs<Realm> args)
    {
        var r = args.Item;

        currentRealm.name = r.name;
        currentRealm.view = r.view;
        currentRealm.DefaultAction = r.DefaultAction;
        currentRealm.PreferredApp = r.PreferredApp;

        editContext.Validate();
    }

    private async Task HandleButtonAddTagClick()
    {
        addButton.ShowLoading("Adding...");

        // await Task.Delay(1000);
        await RealmService.AddOrUpdateRealm(currentRealm.name, currentRealm.view, currentRealm.DefaultAction, currentRealm.PreferredApp);

        allRealms = await RealmService.GetRealmList();

        addButton.HideLoading();
    }

    private async Task HandleButtonDeleteTagClick()
    {
        deleteButton.ShowLoading("Deleting...");

        // await Task.Delay(1000);
        await RealmService.DeleteRealm(currentRealm.name);

        allRealms = await RealmService.GetRealmList();

        deleteButton.HideLoading();
    }

    private async Task HandleInputConsumeClick(InputFileChangeEventArgs e)
    {
        var file = e.File;

        using var reader = new StreamReader(file.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024));
        var content = await reader.ReadToEndAsync();

        var tokenResponse = await Http.GetFromJsonAsync<AntiforgeryTokenDto>("/api/antiforgery/token");
        var token = tokenResponse?.Token;

        var requestMessage = new HttpRequestMessage(HttpMethod.Post, "/api/processfile");
        requestMessage.Headers.Add("X-XSRF-TOKEN", token!);
        requestMessage.Content = JsonContent.Create(new { FileContent = content });

        var response = await Http.SendAsync(requestMessage);
        var result = await response.Content.ReadFromJsonAsync<ResultDto>();

        Console.WriteLine($"Python result: {result?.Result}");
    }

    private void HandleValidationChanged(object? sender, ValidationStateChangedEventArgs e)
    {
        formIsValid = !editContext.GetValidationMessages().Any();
        StateHasChanged();
    }

    public class ResultDto
    {
        public string Result { get; set; } = string.Empty;
    }

}
